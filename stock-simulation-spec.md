# 株式投資シミュレーション 仕様書

## 概要
株式投資の売買シミュレーションアプリケーション。ローカルの株価データを使用し、移動平均とRSIのチャートを表示しながら、手動で売買を行い、投資成績を確認できる。

---

## 画面レイアウト

### 左側エリア
#### 上部：チャート1（移動平均）
- 株価の移動平均線を表示
  - **MA5**: 5日移動平均線
  - **MA25**: 25日移動平均線
  - **MA75**: 75日移動平均線
- 終値のライン
- 日付の進行に応じてチャートが更新される
- 過去90日分のデータを表示（3ヶ月分）

#### 下部：チャート2（RSI）
- RSI（相対力指数）を表示
  - **期間**: 14日
  - **上限ライン**: 70（買われすぎ）
  - **下限ライン**: 30（売られすぎ）
- 日付の進行に応じてチャートが更新される
- 過去90日分のデータを表示（3ヶ月分）

### 右側エリア
#### 上部：散布図（現在のポジション表示）
- **横軸**: ポジション番号（保有中のポジションの順番）
- **縦軸**: 価格
- **表示内容**:
  - 買いポジション（ロング）：青色の円で表示
  - 売りポジション（ショート）：赤色の円で表示
  - 現在価格：緑色の三角形で表示（各ポジションに対応）
  - 各ポイントにはラベル（「買い1」「買い2」「売り1」「売り2」等）と価格を表示
  - 現在の株価を赤い点線で表示
- **動的更新**:
  - ポジションの追加・決済に応じてリアルタイム更新
  - Y軸の範囲は表示価格に応じて自動調整

#### 中部上：相殺決済ポイント表示
- **相殺決済ポイント**とは、複数のポジションを同時決済した際に合計損益がゼロになる価格
- 買いと売りが混在する組み合わせのみを表示（買いだけ、売りだけの組み合わせは除外）
- 各組み合わせを1行で表示：
  - 対象ポジション（例：「買い1, 売り2, 売り3」）
  - 相殺価格（円）

#### 中部下：情報表示部（2列レイアウト）
- 現在の資産状況を2列グリッドで表示
  - 現在日付
  - 経過日数 / 総日数
  - 現在価格
  - 現金残高
  - 保有株数
  - 評価額
  - 総資産（ハイライト表示）
  - 損益（プラス：緑色、マイナス：赤色）
  - ポジション数
  - 決済済取引数

- **ポジション明細**（直近5件）:
  - 各ポジションの詳細情報をカード形式で表示
  - ポジションラベル（買い1、売り2等）
  - ポジションタイプ（ロング/ショート）
  - 取得日
  - 取得単価
  - 数量
  - 評価額
  - 損益（金額と率）

#### 下部：操作ボタン

---

## 操作ボタン仕様

### 1. 買いボタン
- **プルダウンメニュー**:
  - 「新規購入」（ロングポジションの新規作成）
  - 「全ての売りポジションを買戻」（全ショートポジション一括決済）
  - 清算可能な売りポジション（売り1、売り2... 等）
- **動作**:
  - プルダウンで選択した内容に応じて買い注文を実行
  - 同じ日に複数回の売買が可能
  - 資金不足の場合は警告メッセージを表示

### 2. 売りボタン
- **プルダウンメニュー**:
  - 「新規売却」（ショートポジションの新規作成）
  - 「全ての買いポジションを売却」（全ロングポジション一括決済）
  - 清算可能な買いポジション（買い1、買い2... 等）
- **動作**:
  - プルダウンで選択した内容に応じて売り注文を実行
  - 同じ日に複数回の売買が可能
  - 資金不足の場合は警告メッセージを表示

### 3. 次の日へ進むボタン
- **動作**:
  - チャートを1日進める
  - 売買を行った後は、必ずこのボタンを押して日付を進める
  - 期間終了時は自動的に結果画面へ遷移

### 4. 売買単位設定ボタン
- **機能**:
  - 1回の売買で使用する金額を設定
  - 指定金額で購入可能な最大株数を自動計算して売買
  - ゲーム開始時に初期設定
  - ゲーム途中での変更が可能

### 5. 終了ボタン
- **動作**:
  - シミュレーションを途中終了し、結果画面へ遷移

### 6. 戻るボタン
- **動作**:
  - 開始設定画面へ戻る

---

## 株価データ

### データソース
- CSVファイルを`/assets/stock-data/`フォルダから読み込み
- ファイル命名規則: `{企業コード}.csv`（例: `7203.csv`）
- ファイル形式: CSV形式（日付、始値、高値、安値、終値、出来高）

### 企業コード選択
- 300社以上の企業コードをプリセット
- プルダウンメニューから企業を選択
- 主要企業は企業名も表示（トヨタ自動車、ソニーグループ等）
- その他の企業は「会社コード{コード}」として表示

### データ形式
```csv
日付,始値,高値,安値,終値,出来高
2014-01-06,5810,5880,5810,5880,8769100
2014-01-07,5890,5920,5870,5890,7221100
...
```

---

## ゲーム進行

### 開始設定
ゲーム開始時に以下の項目を設定：
1. **企業選択**: プルダウンメニューから企業コード/銘柄を選択
   - 選択すると自動的にCSVファイルを読み込み
   - 読み込み成功時は「XX件のデータを読み込みました」と表示
2. **開始年月日**: シミュレーション開始日（デフォルト: 2014/01/01）
3. **期間**: シミュレーション期間（日数）（デフォルト: 100日）
4. **初期資金**: 開始時の所持金（デフォルト: 1,000,000円）
5. **売買単位金額**: 1回の売買で使用する金額（デフォルト: 100,000円）

### ゲーム進行
- 開始日からスタート
- ボタン操作により1日ずつ進行
- 各操作後に通知メッセージを1秒間表示
- 指定期間が終了したら自動的に結果画面へ遷移
- 途中終了も可能

### 終了処理
ゲーム終了時に以下の投資成績を画面に表示：
- **勝率**: 利益が出た取引の割合（%）
- **利益率**: 総利益 / 初期資金（%）
- **期待値**: 平均損益（円）
- **最大ドローダウン**: 最大損失幅（円）
- **取引回数**: 総売買回数（決済完了した取引のみ）
- **勝ち取引数 / 負け取引数**
- **平均利益 / 平均損失**（円）
- **プロフィットファクター**: 総利益 / 総損失
- **総利益**: 勝ち取引の利益合計（円）
- **総損失**: 負け取引の損失合計（円）

### 売買履歴出力
- ファイル名: `{銘柄}_{YYYYMMDDhhmmss}.txt`
- 出力内容:
  - シミュレーション設定情報
  - 投資成績サマリー
  - 全取引の詳細履歴（日付、売買区分、ラベル、価格、数量、決済損益）

---

## 機能要件

### チャート機能
- **移動平均線の計算と表示**:
  - 5日移動平均（MA5）
  - 25日移動平均（MA25）
  - 75日移動平均（MA75）
- **RSIの計算と表示**:
  - 14日RSI
  - 上限・下限ライン表示
- **日付進行に伴うリアルタイム更新**
- **表示期間**: 過去90日分（3ヶ月）のスライディングウィンドウ

### 売買機能
- **新規買い（ロング）**:
  - 売買単位金額に基づいて株数を自動計算
  - 資金不足チェック
  - ポジションラベルの自動付与（買い1、買い2...）
- **新規売り（ショート）**:
  - 売買単位金額に基づいて株数を自動計算
  - ポジションラベルの自動付与（売り1、売り2...）
- **ポジション決済**:
  - 個別ポジションの決済
  - 全ポジション一括決済（ロング/ショート別）
  - 決済時の損益計算と記録
- **複数ポジションの同時保有**
- **売買単位金額に基づく自動株数計算**

### 資産管理機能
- **現金残高管理**:
  - ロング購入時: 現金減少
  - ショート売却時: 現金増加
  - ロング決済時: 現金増加
  - ショート決済時: 現金減少
- **ポジション管理**:
  - 複数の買い・売りポジションの同時保有
  - ポジションID自動採番
  - ポジションタイプ（LONG/SHORT）
- **評価損益の計算**:
  - ロング: (現在価格 - 買値) × 数量
  - ショート: (売値 - 現在価格) × 数量
- **確定損益の記録**:
  - 決済時の損益を記録
  - 決済済ポジションの保持

### データ管理機能
- **株価データファイルの読み込み**:
  - CSV形式の解析
  - 日付順ソート
  - データキャッシュ
- **売買履歴の記録**:
  - 全取引の記録（新規/決済）
  - 取引日時、価格、数量、ポジション情報
- **投資成績の計算**:
  - リアルタイム計算
  - 最大ドローダウンの追跡

### 相殺決済ポイント計算機能
- **相殺決済ポイントの定義**:
  - 複数の買い・売りポジションを同時決済したときに、損益が０となる株価

- **計算方式**:
  - 買いポジション i について：
    - p_Bi：買い建値（建玉価格）
    - q_Bi：買い数量
  - 売りポジション j について：
    - p_Sj：売り建値（建玉価格）
    - q_Sj：売り数量
  - 相殺決済価格（損益分岐点）:
    - P0 = ( Σ(q_Bi * p_Bi) + Σ(q_Sj * p_Sj) ) / ( Σ(q_Bi) + Σ(q_Sj) )
  - これは全ポジションの加重平均価格に相当する

- **組み合わせ生成とフィルタリング**:
  - 売り m個・買い n個のとき、組合せ総数 = (2^m - 1) × (2^n - 1)
  - 空集合を除外
  - 買いと売りが混在する組み合わせのみを抽出（買いだけ、売りだけの組み合わせは除外）

- **表示情報**（1行形式）:
  - ポジション組み合わせ（ラベル一覧）
  - 相殺価格（円）

### UI/UX機能
- **通知メッセージ**:
  - 売買操作完了時に1秒間メッセージ表示
  - 操作内容の確認
- **リアルタイム更新**:
  - 資産情報の即時更新
  - チャートの即時更新
  - 散布図の即時更新
  - 相殺決済ポイントの即時更新
- **データ検証**:
  - 資金不足の警告
  - データ読み込みエラーの通知

---

## 技術要件

### フレームワーク
- **Angular**: スタンドアロンコンポーネント方式

### チャートライブラリ
- **Chart.js + ng2-charts**
- 各種ライブラリはAngularのバージョンと整合性を合わせ、稼働実績があるバージョンを使用する

### データ形式
- **株価データ**: CSV形式
  - カラム: 日付、始値、高値、安値、終値、出来高
  - 日付形式: YYYY-MM-DD または YYYY/MM/DD

### 技術詳細
- **移動平均計算**: 単純移動平均（SMA）
- **RSI計算**: 14期間、平滑化移動平均方式
- **チャート表示範囲**: 90日（3ヶ月）のスライディングウィンドウ
- **プリロード**: シミュレーション開始日の90日前からデータを取得

---

## 画面遷移

### 1. 開始設定画面
- **企業選択**: プルダウンメニューから選択
  - 企業コードリスト（300社以上）
  - 主要企業は企業名も表示
  - 選択時に自動的にCSVファイルを読み込み
- **開始日**: 日付入力（デフォルト: 2014/01/01）
- **期間**: 数値入力（デフォルト: 100日）
- **初期資金**: 数値入力（デフォルト: 1,000,000円）
- **売買単位**: 数値入力（デフォルト: 100,000円）
- **開始ボタン**: 設定完了後、シミュレーション画面へ遷移

### 2. シミュレーション画面（メイン画面）
- **左側エリア**:
  - 上部: 移動平均チャート
  - 下部: RSIチャート
- **右側エリア**:
  - 上部: 散布図（現在のポジション）
  - 中部: 情報表示（2列レイアウト）
    - 資産状況
    - ポジション明細（直近5件）
  - 下部: 操作パネル
    - 買いボタン（プルダウン）
    - 売りボタン（プルダウン）
    - 次の日へ進むボタン
    - 売買単位設定ボタン
    - 終了ボタン
    - 戻るボタン
    - 売買履歴表示エリア

### 3. 結果表示画面
- **投資成績サマリー**:
  - 勝率、利益率、期待値等を表形式で表示
- **売買履歴出力**:
  - 「履歴をエクスポート」ボタンで.txtファイルをダウンロード
  - ファイル名: `{銘柄}_{YYYYMMDDhhmmss}.txt`
- **再開ボタン**: 画面リロードで最初から

---

## 備考

### 実装済み機能
- Angularフレームワークによる実装
- スタンドアロンコンポーネント方式
- Chart.jsによるチャート描画
- ロング/ショート対応の売買システム
- 複数ポジション同時保有
- リアルタイム資産管理
- 投資成績分析
- 売買履歴出力

### 将来拡張機能（未実装）
- レスポンシブデザイン対応
- データの永続化（ローカルストレージ等）
- 複数銘柄の比較機能
- バックテスト機能（自動売買ストラテジー）
- テクニカル指標の追加（MACD、ボリンジャーバンド等）
- 売買ルールのカスタマイズ機能
